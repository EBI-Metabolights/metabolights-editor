<div class="control">
  <div class="tags has-addons">
    <span class="tag is-dark">Status</span>

    <span class="tag" [class.clickable]="!isReadOnly" (click)="openModal()" [class.is-primary]="status == 'In Review'"
      [class.is-primary]="status == 'Private'" [class.is-warning]="status == 'Provisional'"
      [class.is-success]="status == 'Public'">
      {{
      status
      }}
      <mat-icon *ngIf="!isReadOnly && (curator || status !== 'Public')">edit</mat-icon>
    </span>


    <span *ngIf="!isReadOnly && revisionNumber > 0 && revisionStatus != 'Completed'" class="tag clickable"
      (click)="openRevisionStatusModel()">
      <img src="{{ baseHref }}assets/img/spinner.svg" width="22px" />
    </span>

  </div>

</div>
<div class="modal" [ngClass]="{ 'is-active': isRevisionStatusModalOpen }">
  <div class="modal-background"></div>
  <div class="modal-card">
    <section class="modal-card-body">
      The study metadata and data files are being copied to Public FTP server.
      <span *ngIf="status == 'Private'">
        After completion of the task, study status will be updated to Public.
        If your study is not public within 24 hours, please contact with MetaboLights team.
      </span>
      <span *ngIf="status == 'Public'">
        After completion of the task, new study revision will be published on public FTP server.
      </span>

      <span *ngIf="revisionNumber > 0">
        <br />
        <br />Scheduled revision: <b>{{ revisionNumber }}</b>
        <span>
          <br>Revision created at: <b>{{ revisionDatetime }}</b>
        </span>
        <span *ngIf="revisionTaskMessage != null && revisionTaskMessage.length > 0">

          <br>Revision task message: <b>{{ revisionTaskMessage }}</b>
        </span>
        <span>
          <br>Revision status: <b>{{ revisionStatus }}</b>
        </span>
      </span>


    </section>
    <footer class="modal-card-foot buttons is-right">
      <div class="columns is-gapless full-width">
        <div class="column is-two-third"></div>
        <div class="column is-one-third has-text-right">
          <button class="button" [disabled]="isFormBusy" (click)="closeRevisionStatusModel()">
            Close
          </button>
        </div>
      </div>
    </footer>
  </div>
</div>
<div class="modal" [ngClass]="{ 'is-active': isModalOpen }">
  <div class="modal-background"></div>
  <div class="modal-card">
    <section class="modal-card-body">
      <span *ngIf="status == 'Public'">
        <h4>
          <mat-icon>public</mat-icon>
        </h4>
        <p>
          <b>ACCESSIBILITY</b><br />
          Anyone can view or download dataset. Please ensure you have
          provided your literature publication reference (DOI or PubMed ID) if
          applicable to improve your visibility.
          <br /><br />
          <b>What's next?</b><br />
          The study is public.
        </p>
      </span>
      <span *ngIf="status == 'In Review'">
        <h4>
          <mat-icon>visibility</mat-icon>
        </h4>
        <p>
          <b>ACCESSIBILITY</b><br />
          Your study is in review state.
          <br /><br />
          <b>What's next?</b><br />
          Upon reaching the release date your study will automatically be
          published to allow open access. Please ensure to provide your
          literature publication reference (DOI or PubMed ID) if applicable to
          improve your visibility.
        </p>
      </span>
      <span *ngIf="status == 'Private'">
        <h4>
          <mat-icon>visibility_off</mat-icon>
        </h4>
        <p>
          <b>ACCESSIBILITY</b><br />
          Your study is Private and you cannot make any changes.<br /><br />
          Private studies can be modified at any point. Simply revert to Provisional, edit the study, and remember to
          re-index data files, re-run study validation and change back to Private. <br />
          A <a href="https://ebi-metabolights.github.io/guides/#reviewer-link" target="_BLANK"
            style="text-decoration: underline;">private read-only link</a>
          is available at the top of your study page to share with the editor of the journal, reviewers, collaborators,
          etc.
          <br /><br />
          <b>What's next?</b><br />
        </p>
        <ul class="list-data-policy">
          <li><strong>Manual status update: </strong>You can make your study public by selecting ‘Public’ from the
            drop-down menu below.</li>
          <li><strong>Automatic status update:</strong> MetaboLights can make your study public according to following
            criteria:
            <ul class="sub-list-data-policy">
              <li>The study publication is published in a journal.</li>
              <li>The release date has been reached.</li>
            </ul>
          </li>
        </ul>
        <p>
          Please be aware that once you make your study public, you cannot make any status update again.<br /><br />
          Please check our <a href="https://ebi-metabolights.github.io/guides/#overview" target="_BLANK"
            style="text-decoration: underline;">guides</a> for information on how to reference your MetaboLights study
          in your publication.
        </p>
      </span>
      <span *ngIf="status == 'Provisional'">
        <h4>
          <mat-icon>visibility_off</mat-icon>
        </h4>
        <p>
          <b>ACCESSIBILITY</b><br />
          Your study is provisional. Only study submitters are able to view and make changes to the study
          <br /><br />
          <b>What's next?</b><br />
          Please check our <a target="_BLANK" href="https://ebi-metabolights.github.io/guides/"
            style="text-decoration: underline;">guides</a> for more information on how to complete your study. Check
          that your study passes the required validations checks (see the Study Validations tab in your study).
          <br />Once you have completed your study and it has met the validation criteria, please click in the drop-down
          menu below to change the study status from ‘Provisional’ to ‘Private’.
        </p>
        <br>

        <div *ngIf="validation">
          <div *ngIf="validationStatus !== 'SUCCESS' && validationStatus !== 'WARNING'">
            <p class="error-message">
              Before changing status of your study, please validate your study and fix all errors.
            </p>
          </div>
        </div>


      </span>
      <br />
      <span *ngIf="!isReadOnly">

        <span *ngIf="curator; else submitter">
          <span *ngIf="status == 'Public'">
            <table>
              <tbody>
                <tr>
                  <td>
                    <mat-form-field appearance="outline">
                      <mat-label>Change study status</mat-label>
                      <mat-select (selectionChange)="changeStatusNgxs(toStatus)" [(value)]="toStatus">
                        <mat-option value="New Revision">New Revision</mat-option>
                      </mat-select>
                    </mat-form-field>
                  </td>
                </tr>
              </tbody>
            </table>
          </span>
          <span *ngIf="status != 'Public'">
            <table>
              <tbody>
                <tr>
                  <td>
                    <mat-form-field appearance="outline">
                      <mat-label>Change study status</mat-label>
                      <mat-select (selectionChange)="changeStatusNgxs(toStatus)" [(value)]="toStatus">
                        <mat-option value="Provisional">Provisional</mat-option>
                        <mat-option value="Private">Private</mat-option>

                        <mat-option *ngIf="status !== 'Provisional'" value="New Revision">Public</mat-option>
                      </mat-select>
                    </mat-form-field>
                  </td>
                </tr>
                <!-- <tr *ngIf="
                toStatus !== status &&
                status === 'Provisional' && !firstPrivateDate">
                <td colspan="2">
                  <p>
                    <mat-checkbox class="example-margin" #policycheck (change)="onCheckboxChange(policycheck)"></mat-checkbox>&nbsp;I have read the terms and conditions associated with holding Private Data in MetaboLights 
                  </p>
                </td>
              </tr>   -->
              </tbody>
            </table>
          </span>
          <!-- Revision comment for curator when selecting New Revision -->
          <div class="field" *ngIf="status === 'Public' && toStatus === 'New Revision' && curator"
            style="margin-top:12px;">
            <label class="label">Revision comments<span class="has-text-danger">*</span></label>
            <div class="control">
              <textarea class="textarea" placeholder="Please provide revision comments" [(ngModel)]="revisionComment"
                rows="3" required></textarea>
            </div>
          </div>
        </span>
        <ng-template #submitter>
          <span *ngIf="status == 'Provisional'">
            <table>
              <tbody>
                <tr>
                  <td>
                    <mat-form-field appearance="outline">
                      <mat-label>Change study status</mat-label>
                      <mat-select (selectionChange)="changeStatusNgxs(toStatus)" [(value)]="toStatus">
                        <mat-option value="Provisional">Provisional</mat-option>
                        <mat-option value="Private">Private</mat-option>
                      </mat-select>
                    </mat-form-field>
                  </td>
                </tr>
                <!-- <tr *ngIf="
                toStatus !== status && !firstPrivateDate">
                <td colspan="2">
                  <p>
                    <mat-checkbox class="example-margin" #policycheck (change)="onCheckboxChange(policycheck)"></mat-checkbox>&nbsp;I have read the terms and conditions associated with holding Private Data in MetaboLights 
                  </p>
                </td>
              </tr>  -->
              </tbody>
            </table>
          </span>
          <span *ngIf="status == 'Private' || status == 'In Review'">
            <table>
              <tbody>
                <tr>
                  <td>
                    <mat-form-field appearance="outline">
                      <mat-label>Change study status</mat-label>
                      <mat-select (selectionChange)="changeStatusNgxs(toStatus)" [(value)]="toStatus">
                        <mat-option value="Provisional">Provisional</mat-option>
                        <mat-option value="Private">Private</mat-option>

                        <mat-option *ngIf="revisionNumber == 0" value="New Revision">Public</mat-option>
                      </mat-select>
                    </mat-form-field>
                  </td>
                </tr>
              </tbody>
            </table>
          </span>
        </ng-template>
      </span>
    </section>
    <footer class="modal-card-foot buttons is-right">
      <div class="columns is-gapless full-width">
        <div class="column is-two-third">
          <!-- <small *ngIf="toStatus !== status &&
                status === 'Provisional' && !firstPrivateDate" class="error-message">Tick the data policy checkbox to enable the ‘Apply’ button</small> -->
        </div>
        <div class="column is-one-third has-text-right">
          <!-- <button
            class="button is-info"
            *ngIf="toStatus !== status"
            [disabled]="isFormBusy || (status === 'Provisional' && !firstPrivateDate && !userAgreed)"
            (click)="applyChanges()">
            Apply
          </button>&nbsp; -->
          <button class="button is-info" *ngIf="toStatus !== status"
            [disabled]="isFormBusy || (toStatus === 'New Revision' && status === 'Public' && curator && (!revisionComment || revisionComment.trim().length === 0))"
            (click)="applyChanges()">
            Apply
          </button>&nbsp;
          <button class="button" [disabled]="isFormBusy" (click)="closeModal()">
            Close
          </button>
        </div>
      </div>
    </footer>
  </div>
</div>
<data-policy-modal *ngIf="isPopupOpen" (confirm)="handlePopupClose($event)">
</data-policy-modal>
