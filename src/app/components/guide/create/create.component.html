<nav-bar mode="light"></nav-bar>
<div class="container fixed-navbar-offset">
  <mtbls-progress [study]="newStudy" [step]="currentSubStep" [internalNavigationOnly]="true"
    (stepClick)="onStepClick($event)" [allowBackward]="currentSubStep < 4"
    [hidePublicationStep]="false"></mtbls-progress>

  <div [ngSwitch]="currentSubStep">
    <!-- Step 1: Submission Details -->
    <div *ngSwitchCase="1">
      <div class="columns is-centered mt-4">
        <div class="column is-10">
          <div class="box">
            <h2 class="title is-4 has-text-weight-bold mb-5">New Submission -> Start</h2>
            <!-- Categories & Assays -->
            <div class="box gray-box mb-4">
              <p [class.has-text-danger]="!isAnyAssaySelected" style="margin-bottom: 10px;">
                Which type of techniques have you used in your study?
                <span *ngIf="!isAnyAssaySelected" class="is-italic">(At least one selection is required)</span>
              </p>
              <div class="category-rows-container mt-4">
                <div class="category-box mb-3" *ngFor="let cat of activeCategories">
                  <div class="columns is-vcentered">
                    <div class="column is-2 py-1">
                      <span class="is-size-7 has-text-weight-bold has-text-grey">{{cat.label}}</span>
                    </div>
                    <div class="column py-1">
                      <div class="assay-types-list is-flex is-flex-wrap-wrap" style="gap: 0.5rem;">
                        <div *ngFor="let assayType of cat.assayTypes">
                          <label class="checkbox is-size-7 beautified-checkbox assay-type-label mb-0">
                            <input type="checkbox" (change)="toggleAssay(cat.id, assayType, $event)"
                              [checked]="studyAssaySelection[cat.id]?.includes(assayType)">
                            <span class="checkmark"></span>
                            {{assayType}}
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- <hr class="mt-4 mb-4"> -->
              <!-- <div class="columns" [formGroup]="studyCreationForm">




                <div class="column dropdown-col">
                  <mat-form-field class="full-width" appearance="outline">
                    <mat-label>Sample File Template</mat-label>
                    <mat-select [formControl]="studyCreationForm.get('sampleFileTemplate')"
                      [ngModel]="selectedSampleFileTemplate" (ngModelChange)="onSampleTemplateChange($event)">
                      <mat-option *ngFor="let temp of sampleFileTemplateOptions" [value]="temp.id">
                        {{temp.label}}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div> -->
            </div>
            <hr />
            <!-- Contacts (Moved from Step 2) -->
            <div class="column is-12">
              <div class="is-justify-content-space-between is-align-items-center mb-4">
                <h3 class="title is-5 has-text-weight-bold" style="margin-bottom: 0;">Contacts*</h3>
                <button class="button is-primary is-small" style="float: right;margin-bottom: 10px;"
                  (click)="addNewContact()">+ Add
                  Contact</button>
              </div>
              <p *ngIf="contacts.length > 0 && !hasPrincipalInvestigator" class="has-text-danger is-size-7 mb-3 ml-2">
                • No Principal Investigator found. At least one contact must have the 'Principal Investigator' role.
              </p>
              <div class="box p-3 is-clearfix" style="clear:both;">
                <div class="columns is-multiline">
                  <div class="column is-4" *ngFor="let contact of contacts; let i = index">
                    <div class="card contact-card" [class.invalid-card]="!isContactValid(contact)">
                      <div class="card-content p-3">
                        <p class="is-size-7 has-text-weight-bold">{{contact.firstName}} {{contact.lastName}}</p>
                        <p class="is-size-7">{{contact.affiliation}}</p>
                        <p class="is-size-7 has-text-grey">{{contact.roles?.[0]?.annotationValue}}</p>
                        <div *ngIf="!isContactValid(contact)" class="has-text-danger is-size-7 mt-2 pt-1"
                          style="border-top: 1px dashed #ff3860;">
                          <div *ngFor="let error of getContactErrors(contact)">• {{error}}</div>
                        </div>
                        <div style="position: absolute; top: 5px; right: 5px; display: flex;">
                          <span class="material-symbols-outlined is-size-6 has-text-grey clickable mr-1"
                            (click)="editContact(contact, i)" title="Edit contact">
                            edit
                          </span>
                          <button class="delete is-small" (click)="removeContactCompat(contact, i)"
                            title="Remove contact"></button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <mtbls-person #personEditor class="is-modal-only-person" [mode]="'local'"
                  (saved)="saveContactCompat($event)"></mtbls-person>
              </div>
            </div>

            <hr />
            <!-- Agreements -->
            <div class="field">
              <div>
                <mat-checkbox [(ngModel)]="agreements.datasetLicenseAgreement" color="primary"
                  [class.warn-unchecked]="!agreements.datasetLicenseAgreement">
                  I accept the terms of the MetaboLights dataset license
                  <a target="_blank" [href]="licenseUrl" *ngIf="licenseUrl" class="ml-1">( {{licenseName}} )</a>
                </mat-checkbox>
              </div>
              <div>
                <mat-checkbox [(ngModel)]="agreements.datasetPolicyAgreement" color="primary"
                  [class.warn-unchecked]="!agreements.datasetPolicyAgreement">
                  I confirm that I have read and agree to adhere to the
                  <a href="https://www.ebi.ac.uk/metabolights/editor/datapolicy" target="_blank"
                    class="ml-1">MetaboLights Data Policy</a>.
                </mat-checkbox>
              </div>
            </div>
            <div class="field is-grouped is-pulled-right mt-4">
              <div class="control">
                <button class="button is-primary" (click)="currentSubStep = 2"
                  [disabled]="!isStep1Valid">Continue</button>
              </div>

            </div>
            <div class="is-clearfix">
            </div>

          </div>

        </div>

      </div>
    </div>

    <!-- Step 2: Study Description -->
    <div *ngSwitchCase="2">
      <div class="columns is-centered mt-4">
        <div class="column is-10">
          <div class="box">
            <h2 class="title is-5 has-text-weight-bold mb-5">Study Description</h2>
            <!-- Study Title -->
            <div class="field mb-4">
              <mat-form-field class="full-width" appearance="outline">
                <mat-label>Study Title (min 25 chars)*</mat-label>
                <input matInput type="text" [(ngModel)]="studyTitle"
                  placeholder="Enter a descriptive title for your study">
                <mat-hint *ngIf="studyTitle && studyTitle.trim().length < 25" class="has-text-danger">
                  Title must be at least 25 characters.
                </mat-hint>
              </mat-form-field>
            </div>

            <!-- Study Description -->
            <div class="field mb-4">
              <mat-form-field class="full-width" appearance="outline">
                <mat-label>Study Description (min 60 chars)*</mat-label>
                <textarea matInput [(ngModel)]="studyDescription" placeholder="Please provide a description of your experiment, why not use the abstract of your paper (min 60 chars)
" rows="5"></textarea>
                <mat-hint *ngIf="studyDescription && studyDescription.trim().length < 60" class="has-text-danger">
                  Description must be at least 60 characters.
                </mat-hint>
              </mat-form-field>
            </div>
            <hr>
            <!-- Factors, Descriptors, Contacts -->
            <div class="columns is-multiline">
              <div class="column is-12">
                <h3 class="title is-5 has-text-weight-bold mb-4">Study Factors</h3>
                <div class="box p-3 is-clearfix" style="position: relative;">
                  <button class="button is-primary is-small" style="position: absolute; top: 12px; right: 12px; "
                    (click)="factorRef.openModal()">+
                    Add</button>
                  <div class="tags mb-2" style="margin-right: 60px;">
                    <span *ngFor="let factor of factors; let i = index" class="tag is-primary is-light is-medium">
                      {{factor.factorName}} ({{factor.factorType?.annotationValue}})
                      <button class="delete is-small" (click)="removeFactorCompat(factor, i)"></button>
                    </span>
                  </div>
                  <mtbls-factor #factorRef [mode]="'local'" (saved)="addFactorCompat($event)"></mtbls-factor>
                </div>

              </div>
              <div class="column is-12">
                <h3 class="title is-5 has-text-weight-bold mb-4">Design Descriptors (Keywords)</h3>
                <div class="mb-4" *ngFor="let category of activeDesignDescriptorCategories">
                  <div class="box p-3 is-clearfix" style="position: relative;">
                    <button class="button is-primary is-small" style="position: absolute; top: 12px; right: 12px; "
                      (click)="descRef.openModal()">+
                      Add</button>
                    <h6 class="title is-6 mb-2" style="margin-right: 60px;">{{category.label}} <span
                        *ngIf="category.min > 0">(at least {{category.min}})*</span></h6>
                    <div class="tags mb-2" style="margin-right: 60px;">
                      <span *ngFor="let desc of getDescriptorsByCategory(category.id); let i = index"
                        class="tag is-primary is-light is-medium">
                        {{desc.annotationValue}}
                        <button class="delete is-small" (click)="removeDescriptorCompat(desc)"></button>
                      </span>
                    </div>
                    <mtbls-design-descriptor #descRef [mode]="'local'" [controlListKey]="category.controlListKey"
                      [isaFileType]="category.isaFileType"
                      [templateVersion]="templateConfiguration?.defaultTemplateVersion"
                      [isaFileTemplateName]="selectedInvestigationFileTemplate"
                      [selectedStudyCategories]="selectedStudyCategoryIds"
                      (saved)="addDescriptorWithCategory($event, category.id)"></mtbls-design-descriptor>
                  </div>
                </div>

                <div class="mb-2">
                  <div class="box p-3 is-clearfix" style="position: relative;">
                    <button class="button is-primary is-small" style="position: absolute; top: 12px; right: 12px;"
                      (click)="kwRef.openModal()">+
                      Add</button>
                    <h6 class="title is-6 mb-2" style="margin-right: 60px;"
                      *ngIf="activeDesignDescriptorCategories.length > 0">Others</h6>
                    <div class="tags mb-2" style="margin-right: 60px;">
                      <span *ngFor="let desc of getKeywords(); let i = index" class="tag is-primary is-light is-medium">
                        {{desc.annotationValue}}
                        <button class="delete is-small" (click)="removeDescriptorCompat(desc)"></button>
                      </span>
                    </div>
                    <mtbls-design-descriptor #kwRef [mode]="'local'" [controlListKey]="'Study Design Type'"
                      [templateVersion]="templateConfiguration?.defaultTemplateVersion"
                      [isaFileTemplateName]="selectedInvestigationFileTemplate"
                      [selectedStudyCategories]="selectedStudyCategoryIds"
                      (saved)="addKeyword($event)"></mtbls-design-descriptor>
                  </div>
                </div>
              </div>

            </div>
            <hr>
            <div class="field is-grouped is-pulled-right">
              <div class="control">
                <button class="button is-light" (click)="currentSubStep = 1">Back</button>
              </div>
              <div class="control">
                <button class="button is-primary" (click)="createStudy()" [disabled]="!isStep2Valid">
                  Continue
                </button>
              </div>
            </div>
            <div class="is-clearfix"></div>

          </div>

        </div>

      </div>
    </div>

    <!-- Step 3: Publication & Funding -->
    <div *ngSwitchCase="3">
      <div class="columns is-centered mt-4">
        <div class="column is-10">
          <div class="box">
            <div class="box gray-box mb-4">
              <h4 class="title is-5 has-text-weight-bold mb-5">Publication</h4>
              <div class="category-rows-container mt-4">
                <!-- Publication Title -->
                <div class="field mb-4">
                  <mat-form-field class="full-width" appearance="outline">
                    <mat-label>Publication Title*</mat-label>
                    <input matInput type="text" [(ngModel)]="publicationTitle" placeholder="Publication Title">
                    <mat-hint *ngIf="fieldValidation('publications.publication.title').description">
                      {{ fieldValidation('publications.publication.title').description }}
                    </mat-hint>
                  </mat-form-field>
                </div>

                <!-- Row 1: Authors and Status -->
                <div class="columns mb-3">
                  <div class="column is-6 pb-0">
                    <div class="field">
                      <mat-form-field class="full-width" appearance="outline">
                        <mat-label>Publication Authors</mat-label>
                        <input matInput type="text" [(ngModel)]="publicationAuthors" placeholder="Publication Authors"
                          required>
                        <mat-hint>{{ fieldValidation('publications.publication.authorList').description }}</mat-hint>
                      </mat-form-field>
                    </div>
                  </div>
                  <div class="column is-6 pb-0">
                    <div class="field">
                      <div class="control">
                        <ng-container
                          *ngIf="publicationStatusControlList && !publicationStatusControlList.renderAsDropdown; else publicationStatusDropdown">
                          <!-- Keep mtbls-ontology as is since it was already redesigned for premium Material -->
                          <label class="label is-small">Publication Status*</label>
                          <mtbls-ontology [controlList]="publicationStatusControlList" [values]="publicationStatus"
                            (changed)="onPublicationStatusChange($event)"
                            [validations]="fieldValidation('publications.publication.status')" [inline]="true"
                            [rule]="publicationStatusControlList?.rule"
                            [defaultOntologies]="publicationStatusControlList?.defaultOntologies">
                          </mtbls-ontology>
                        </ng-container>
                        <ng-template #publicationStatusDropdown>
                          <div *ngIf="publicationStatusControlList?.values?.length">
                            <mat-form-field class="full-width" appearance="outline">
                              <mat-label>Publication Status*</mat-label>
                              <mat-select [value]="publicationStatus[0]?.annotationValue"
                                (selectionChange)="onPublicationStatusChange($event.value)">
                                <mat-option *ngFor="let option of publicationStatusControlList.values"
                                  [value]="option.annotationValue">
                                  {{ option.annotationValue }}
                                </mat-option>
                              </mat-select>
                              <mat-hint>{{ fieldValidation('publications.publication.status').description }}</mat-hint>
                            </mat-form-field>
                          </div>
                        </ng-template>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Row 2: DOI and PubMed ID -->
                <div class="columns mb-3">
                  <div class="column is-6 pb-0">
                    <div class="field">
                      <div class="control">
                        <mat-form-field class="full-width" appearance="outline"
                          [color]="(isDoiRequired && !publicationDoi) ? 'warn' : 'primary'">
                          <mat-label>DOI<span *ngIf="isDoiRequired">*</span></mat-label>
                          <input matInput type="text" [(ngModel)]="publicationDoi" placeholder="DOI"
                            [required]="isDoiRequired">
                          <mat-hint>{{ fieldValidation('publications.publication.doi').description }}
                            <span *ngIf="isDoiRequired"><b>(required)</b></span>
                          </mat-hint>
                        </mat-form-field>
                        <p class="help is-danger" *ngIf="doiErrorMessage" style="margin-top: 4px;">{{ doiErrorMessage }}
                        </p>
                      </div>
                    </div>
                  </div>
                  <div class="column is-6 pb-0">
                    <div class="field">
                      <div class="control">
                        <mat-form-field class="full-width" appearance="outline">
                          <mat-label>PubMed ID</mat-label>
                          <input matInput type="text" [(ngModel)]="publicationPubmedId" placeholder="PubMed ID">
                          <mat-hint>{{ fieldValidation('publications.publication.pubmedId').description }}</mat-hint>
                        </mat-form-field>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
            <hr />
            <!-- Funding -->
            <mtbls-funding [funders]="funders" (saved)="addFunderCompat($event.funder, $event.index)"
              (deleted)="removeFunderCompat($event)"></mtbls-funding>
            <br />
            <!-- Related Datasets -->
            <mtbls-related-datasets [datasets]="relatedDatasets"
              (saved)="addDatasetCompat($event.dataset, $event.index)"
              (deleted)="removeDatasetCompat($event)"></mtbls-related-datasets>

            <hr>
            <div class="field is-grouped is-pulled-right">
              <div class="control">
                <button class="button is-light" (click)="currentSubStep = 2">Back</button>
              </div>
              <div class="control">
                <button class="button is-primary" (click)="triggerSubmit()" [disabled]="isLoading || !isStep3Valid">
                  <mat-spinner [diameter]="20" [strokeWidth]="3" *ngIf="isLoading"></mat-spinner>&nbsp;Create Study
                </button>
              </div>
            </div>
            <div class="is-clearfix"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Sample & Assays -->
    <div *ngSwitchCase="4">
      <div class="mt-4" *ngIf="newStudy">
        <guide-assays [hideNav]="true" (next)="currentSubStep = 5"></guide-assays>

      </div>
    </div>

    <!-- Step 5: Upload -->
    <div *ngSwitchCase="5">
      <div class="mt-4" *ngIf="newStudy">
        <raw-upload [hideNav]="true" (next)="onFinishWizard()"></raw-upload>

      </div>
    </div>
  </div>


  <app-confirmation-dialog *ngIf="showConfirmationModal" [title]="confirmationTitle" [message]="confirmationMessage"
    [moreinfo]="''" (confirm)="onConfirmSelection($event)"></app-confirmation-dialog>

</div>